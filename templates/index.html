<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZImage</title>
    <style>
        :root {
            --bg: #000000;
            --surface: #121212;
            --surface-2: #1e1e1e;
            --primary: #8b5cf6; /* Vivid Violet */
            --primary-dark: #7c3aed;
            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --border: #27272a;
            --danger: #ef4444;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        /* HEADER */
        header {
            padding: calc(var(--safe-area-top) + 15px) 20px 15px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-weight: 900; font-size: 22px; letter-spacing: -1px; background: linear-gradient(to right, #fff, #a1a1aa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge { background: var(--primary); color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; }

        /* MAIN LAYOUT */
        main { flex: 1; padding: 20px; padding-bottom: calc(var(--safe-area-bottom) + 80px); max-width: 600px; margin: 0 auto; width: 100%; }

        /* IMAGE VIEWER */
        .viewer {
            width: 100%;
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .viewer img { width: 100%; height: auto; display: none; object-fit: contain; }
        
        /* Placeholder & Loader */
        .placeholder { text-align: center; color: var(--text-secondary); padding: 20px; }
        .placeholder p { font-size: 14px; margin-top: 10px; opacity: 0.7; }
        .loader-ring { display: none; width: 40px; height: 40px; border: 3px solid var(--surface-2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* CONTROLS */
        .control-group { margin-bottom: 20px; position: relative; }
        
        textarea {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: white;
            padding: 18px;
            padding-bottom: 45px; /* Space for Enhance button */
            border-radius: 16px;
            font-size: 16px; /* Prevents iOS zoom */
            resize: none;
            outline: none;
            transition: border 0.2s;
            line-height: 1.4;
        }
        textarea:focus { border-color: var(--primary); }
        textarea::placeholder { color: #555; }

        .btn-enhance {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(139, 92, 246, 0.15);
            color: #c4b5fd;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        /* SETTINGS ACCORDION */
        .settings-btn {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .settings-content {
            display: none;
            background: var(--surface-2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            animation: slideDown 0.2s ease;
        }
        .settings-content.open { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORM ELEMENTS */
        .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .form-col { flex: 1; }
        label { display: block; font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px; }
        select, input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            -webkit-appearance: none;
        }
        
        /* GENERATE BUTTON */
        .btn-main {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 25px rgba(139, 92, 246, 0.4);
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-main:disabled { opacity: 0.6; background: var(--surface-2); box-shadow: none; cursor: wait; }

        /* HISTORY */
        .history-header { margin-top: 40px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .history-label { font-size: 16px; font-weight: 800; }
        .history-clear { font-size: 12px; color: var(--danger); opacity: 0.8; }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }
        .history-card {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            position: relative;
            border: 1px solid var(--border);
        }
        .history-card img { width: 100%; height: 100%; object-fit: cover; }
        .history-card:active { opacity: 0.7; }

        /* TOAST NOTIFICATION */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }

    </style>
</head>
<body>

    <header>
        <div class="logo">ZImage<span class="badge">PRO</span></div>
    </header>

    <main>
        <!-- Viewer -->
        <div class="viewer" id="viewer">
            <div id="placeholder" class="placeholder">
                <div style="font-size: 30px; margin-bottom: 10px;">ðŸŽ¨</div>
                <div>AI Canvas Ready</div>
                <p>Long press result to save</p>
            </div>
            <div id="loader" class="loader-ring"></div>
            <img id="resultImg" alt="Result">
        </div>

        <!-- Inputs -->
        <div class="control-group">
            <textarea id="prompt" rows="3" placeholder="Describe your imagination..."></textarea>
            <button class="btn-enhance" onclick="enhancePrompt()">âœ¨ AI Enhance</button>
        </div>

        <!-- Settings Drawer -->
        <div class="settings-btn" onclick="toggleSettings()">
            <span>ðŸ›  Tune Adjustments</span>
            <span style="font-size: 10px;">â–¼</span>
        </div>
        <div class="settings-content" id="settings">
            <div class="form-row">
                <div class="form-col">
                    <label>Resolution</label>
                    <select id="quality">
                        <option value="HD">HD (Fast)</option>
                        <option value="4K">4K (Ultra)</option>
                        <option value="8K">8K (Slow)</option>
                    </select>
                </div>
                <div class="form-col">
                    <label>Format</label>
                    <select id="ratio">
                        <option value="1:1">Square</option>
                        <option value="9:16">Story</option>
                        <option value="16:9">Cinema</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label>Style Seed</label>
                    <input type="number" id="seed" placeholder="Random (-1)">
                </div>
            </div>
            <label>Negative Filter</label>
            <input type="text" id="negative" value="ugly, blurry, low quality, text, watermark">
        </div>

        <button class="btn-main" id="genBtn" onclick="startGen()">GENERATE</button>

        <!-- History -->
        <div class="history-header">
            <span class="history-label">Library</span>
            <span class="history-clear" onclick="clearHistory()">Clear All</span>
        </div>
        <div class="history-grid" id="historyGrid">
            <!-- JS Injects Here -->
        </div>
    </main>

    <!-- Notification Toast -->
    <div id="toast">Notification</div>

    <script>
        // --- STATE MANAGEMENT ---
        let history = JSON.parse(localStorage.getItem('zHistory') || '[]');

        // --- UI FUNCTIONS ---
        function toggleSettings() {
            document.getElementById('settings').classList.toggle('open');
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg;
            t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        }

        function updateHistoryUI() {
            const grid = document.getElementById('historyGrid');
            grid.innerHTML = '';
            history.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.onclick = () => loadFromHistory(idx);
                card.innerHTML = `<img src="${item.url}" loading="lazy">`;
                grid.appendChild(card);
            });
        }

        // --- API ACTIONS ---
        async function enhancePrompt() {
            const input = document.getElementById('prompt');
            const original = input.value;
            if(!original) return showToast("Enter a prompt first!");
            
            input.value = "Optimizing with Gemini...";
            try {
                const res = await fetch('/enhance', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt: original})
                });
                const data = await res.json();
                input.value = data.enhanced || original;
                showToast("Prompt Enhanced!");
            } catch(e) {
                input.value = original;
                showToast("Enhance failed");
            }
        }

        async function startGen() {
            const prompt = document.getElementById('prompt').value;
            if(!prompt) return showToast("Please enter a prompt");

            // UI Loading
            const btn = document.getElementById('genBtn');
            const img = document.getElementById('resultImg');
            const ph = document.getElementById('placeholder');
            const loader = document.getElementById('loader');

            btn.disabled = true;
            btn.innerText = "CREATING...";
            img.style.display = 'none';
            ph.style.display = 'none';
            loader.style.display = 'block';

            try {
                const payload = {
                    prompt: prompt,
                    negative: document.getElementById('negative').value,
                    ratio: document.getElementById('ratio').value,
                    quality: document.getElementById('quality').value,
                    seed: document.getElementById('seed').value || "-1"
                };

                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                // Load Image
                img.src = data.image_url;
                img.onload = () => {
                    loader.style.display = 'none';
                    img.style.display = 'block';
                    btn.disabled = false;
                    btn.innerText = "GENERATE";
                    
                    // Save to History
                    history.unshift({ url: data.image_url, prompt: prompt });
                    if(history.length > 50) history.pop(); // Keep last 50
                    localStorage.setItem('zHistory', JSON.stringify(history));
                    updateHistoryUI();
                };
                
                img.onerror = () => { throw new Error("Image load failed"); }

            } catch(e) {
                loader.style.display = 'none';
                ph.style.display = 'block';
                ph.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
                btn.disabled = false;
                btn.innerText = "GENERATE";
                showToast("Generation Failed");
            }
        }

        // --- HISTORY ACTIONS ---
        function loadFromHistory(idx) {
            const item = history[idx];
            document.getElementById('prompt').value = item.prompt;
            document.getElementById('resultImg').src = item.url;
            document.getElementById('resultImg').style.display = 'block';
            document.getElementById('placeholder').style.display = 'none';
            window.scrollTo({top:0, behavior:'smooth'});
            showToast("Image Loaded");
        }

        function clearHistory() {
            if(confirm("Clear library?")) {
                history = [];
                localStorage.removeItem('zHistory');
                updateHistoryUI();
            }
        }

        // Init
        updateHistoryUI();

    </script>
</body>
</html>
